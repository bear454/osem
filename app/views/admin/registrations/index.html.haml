= javascript_include_tag 'Chart'

.row
  .col-md-12
    .page-header
      %h1
        Registrations
        = "(#{@registrations.length})" if @registrations
        .btn-group.pull-right
          - if can? :read, Registration
            = link_to 'Export CSV', admin_conference_registrations_path(@conference.short_title, format: :csv), class: 'btn btn-success'
            = link_to 'Export PDF', admin_conference_registrations_path(@conference.short_title, format: :pdf), class: 'btn btn-success'
            = link_to 'Export XLS', {format: :xlsx}, class: 'btn btn-success'
      %p.text-muted
        All the people who registered to your event
.row
  .col-md-12
    %div.margin-event-table
      %table.datatable#registrations
        %thead
          %tr
            %th ID#
            %th Name
            %th Email
            - if @code_of_conduct
              %th
                %abbr{ title: 'Code of Conduct' } CoC
            - Feature.with(:travel_dates) do
              %th Arrival
              %th Departure
            %th Attendance
            %th
            %th
        %tbody
          - @registrations.each_with_index do |registration, index|
            - cache [:admin, registration, registration.user] do
              - user = registration.user
              - token = user.ticket_purchases.select{|p| p.ticket_id == @ticket.id }&.first&.physical_tickets&.first&.token
              %tr
                %td
                  = registration.id
                %td
                  = registration.name.present? ? registration.name : registration.username
                  %b
                  - registration.user.roles.select{|r| r.resource == @conference}.each do |role|
                    %span.label.label-info
                      = role.name.titleize
                %td
                  = registration.email
                - if @code_of_conduct
                  - if registration.accepted_code_of_conduct
                    %td.text-success.text-center= fa_icon('check', title: 'accepted')
                  - else
                    %td.text-center.text-warning
                      = fa_icon('exclamation-circle',
                        title: 'Has not accepted Code of Conduct')
                - Feature.with(:travel_dates) do
                  %td
                    - if registration.arrival
                      = registration.arrival.strftime('%d %b %H:%M')
                    - else
                      n/a
                  %td
                    - if registration.departure
                      = registration.departure.strftime('%d %b %H:%M')
                    - else
                      n/a
                - if registration.attended
                  %td.text-success.text-center= fa_icon('check-square-o', title: 'attended')
                - else
                  %td.text-muted.text-center
                    = fa_icon('square-o', title: 'never checked in')

                - if token
                  %td
                    .btn-group
                      = link_to(conference_physical_ticket_path(@conference.short_title,
                        token, format: :pdf),
                        class: 'btn btn-success', target: '_blank') do
                        = fa_icon 'print', text: 'Badge'
                      = link_to(admin_scan_ticket_path(token: token),
                        class: 'btn btn-primary') do
                        = fa_icon('sign-in', text: 'Check-in')
                - else
                  - ticket_purchase = TicketPurchase.new(user: user, ticket: @ticket, conference: @conference)
                  = form_for(ticket_purchase, url: give_admin_conference_ticket_path(@conference, @ticket)) do |f|
                    %td
                      = f.hidden_field :user_id
                      = f.button fa_icon('ticket', text: 'Give Ticket'),
                        type: :submit, class: 'btn btn-warning'
                %td
                  .btn-group
                    = link_to edit_admin_conference_registration_path(@conference.short_title, id: registration),
                      class: 'btn btn-primary' do
                      = fa_icon 'pencil', text: 'Edit'
                    = link_to admin_conference_registration_path(@conference.short_title, registration),
                      method: :delete, class: 'btn btn-danger',
                      data: { confirm: "Do you really want to delete the Registration for #{registration.name}?" } do
                      = fa_icon 'trash-o', text: 'Delete'
